<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãŠã¿ã‚„ã’ç®—ã‚²ãƒ¼ãƒ </title>
<style>*{margin:0;padding:0;box-sizing:border-box;}body{font-family:'Noto Sans JP','Hiragino Sans',sans-serif;}</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

const C={bg:"#faf8f3",bgSoft:"#f3f0e8",card:"#ffffff",cardBorder:"#e8e2d6",mint:"#7ecba1",mintLight:"#e4f5ec",mintDark:"#4aa578",pink:"#f2a1b3",pinkLight:"#fce8ed",pinkDark:"#d4778c",cream:"#fff8e7",creamDark:"#f5d88a",orange:"#f5a623",orangeLight:"#fff3e0",text:"#3d3629",textSoft:"#8a8175",textMuted:"#b8b0a3",correct:"#6bc48f",correctBg:"#e4f5ec",wrongGrey:"#d0cdc6",wrongGreyBg:"#edebe6",cherry:"#e53935",cherryLight:"#ffebee"};

const LEVELS=[
  {name:"ãƒ¬ãƒ™ãƒ«1",label:"ä¸€ã‘ãŸï¼‹ä¸€ã‘ãŸ",type:"sakuranbo",gen:"s1",count:10},
  {name:"ãƒ¬ãƒ™ãƒ«2",label:"äºŒã‘ãŸï¼‹ä¸€ã‘ãŸ",type:"sakuranbo",gen:"s2",count:10},
  {name:"ãƒ¬ãƒ™ãƒ«3",label:"äºŒã‘ãŸï¼‹äºŒã‘ãŸ",type:"sakuranbo",gen:"s3",count:10},
  {name:"ãƒ¬ãƒ™ãƒ«4",label:"äºŒã‘ãŸâˆ’ä¸€ã‘ãŸ",type:"sakuranbo_sub",gen:"m1",count:10},
  {name:"ãƒ¬ãƒ™ãƒ«5",label:"äºŒã‘ãŸâˆ’äºŒã‘ãŸ",type:"sakuranbo_sub",gen:"m2",count:10},
  {name:"ãƒ¬ãƒ™ãƒ«6",label:"ä¸‰ã‘ãŸâˆ’äºŒã‘ãŸ",type:"sakuranbo_sub",gen:"m3",count:10},
  {name:"ãƒ¬ãƒ™ãƒ«7",label:"11Ã—11ã€œ11Ã—19",type:"omiyage",range:[11,11,11,19],count:10},
  {name:"ãƒ¬ãƒ™ãƒ«8",label:"12Ã—12ã€œ12Ã—19",type:"omiyage",range:[12,12,12,19],count:10},
  {name:"ãƒ¬ãƒ™ãƒ«9",label:"13Ã—13ã€œ13Ã—19",type:"omiyage",range:[13,13,13,19],count:10},
  {name:"ãƒ¬ãƒ™ãƒ«10",label:"11ã€œ13 æ··åˆ",type:"omiyage",range:[11,13,11,19],count:10},
  {name:"ãƒ¬ãƒ™ãƒ«11",label:"14ã€œ15 æ··åˆ",type:"omiyage",range:[14,15,14,19],count:10},
  {name:"ãƒ¬ãƒ™ãƒ«12",label:"16ã€œ19 æ··åˆ",type:"omiyage",range:[16,19,16,19],count:10},
  {name:"ãƒ¬ãƒ™ãƒ«13",label:"11ã€œ15 æ··åˆ",type:"omiyage",range:[11,15,11,19],count:10},
  {name:"ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯",label:"å…¨ç¯„å›² 60ç§’",type:"omiyage",range:[11,19,11,19],count:999,timeAttack:60},
];
const TA_INDEX=LEVELS.length-1;

function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}
function rng(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function genSakuranbo(type){let a,b;if(type==="s1"){do{a=rng(2,9);b=rng(2,9);}while(a+b<=10||(a%10+b%10)<=a%10);}else if(type==="s2"){do{a=rng(12,89);b=rng(2,9);}while((a%10)+b<10);}else{do{a=rng(22,79);b=rng(12,59);}while((a%10)+(b%10)<10);}const ans=a+b,t=10-(a%10),p1=t,p2=b-t,rA=a+p1;return{a,b,answer:ans,part1:p1,part2:p2,roundA:rA,choices:mkC(ans)};}
function mkC(ans){const o=new Set();while(o.size<3){const p=[-11,-10,-9,-3,-2,-1,1,2,3,9,10,11];const off=p[rng(0,p.length-1)];const w=ans+off;if(w>0&&w!==ans&&!o.has(w))o.add(w);}return shuffle([ans,...o]);}
function genOmiyage(r){const a=rng(r[0],r[1]),b=rng(r[2],r[3]);return{a,b,answer:a*b,choices:mkC(a*b)};}
function genSakuranboSub(type){let a,b;if(type==="m1"){do{a=rng(12,89);b=rng(2,9);}while((a%10)>=b);}else if(type==="m2"){do{a=rng(22,89);b=rng(12,a-11);}while((a%10)>=(b%10)||b>=a);}else{do{a=rng(112,289);b=rng(12,59);}while((a%10)>=(b%10)||b>=a);}const ans=a-b,ones=a%10,p1=ones,p2=b-ones,roundA=a-p1;return{a,b,answer:ans,part1:p1,part2:p2,roundA,choices:mkC(ans)};}
function genQ(lv){if(lv.type==="sakuranbo")return genSakuranbo(lv.gen);if(lv.type==="sakuranbo_sub")return genSakuranboSub(lv.gen);return genOmiyage(lv.range);}

function getScorePts(combo){return combo>=4?200:combo>=2?150:100;}
function getStars(cc,tq,ta){if(ta)return cc>=15?3:cc>=10?2:cc>=1?1:0;const r=cc/tq;return r>=1?3:r>=0.8?2:r>=0.6?1:0;}
function getClearAlt(s){return s===3?10:s===2?5:s>=1?3:0;}
const FIRST_CLEAR_ALT=5;

/* â”€â”€ Ranking: GAS API + persistent_storage fallback â”€â”€ */
const GAS_URL="https://script.google.com/macros/s/AKfycbzKUyiUHIMp9JRFX0LEa88plEoavkbrjTQ5oHf9T-FDd6b4fhqfTCBVBy5rWUZPUQbY/exec";
const GAME_ID=13;const GAME_NAME="ãŠåœŸç”£æš—ç®—";

function getWeekStart(){const now=new Date();const d=new Date(now);d.setHours(4,0,0,0);const day=d.getDay();const diff=day===0?6:day-1;d.setDate(d.getDate()-diff);if(now<d)d.setDate(d.getDate()-7);return d.getTime();}

// persistent_storage helpers (localStorage fallback for GitHub Pages)
async function loadLocal(key){try{const r=localStorage.getItem("omiyage-"+key);return r?JSON.parse(r):[];}catch{return[];}}
async function saveLocal(key,data){try{localStorage.setItem("omiyage-"+key,JSON.stringify(data));}catch(e){console.error("local save err",e);}}

// GAS API helpers
async function gasGet(params){try{const url=GAS_URL+"?"+new URLSearchParams(params).toString();const r=await fetch(url);return await r.json();}catch(e){console.error("GAS GET err",e);return null;}}
async function gasPost(data){try{const r=await fetch(GAS_URL,{method:"POST",body:JSON.stringify(data)});return await r.json();}catch(e){console.error("GAS POST err",e);return null;}}

async function submitScore(name,gameScore,ts){
  // 1) Save to GAS
  const gasRes=await gasPost({action:"saveRanking",gameId:GAME_ID,gameName:GAME_NAME,player:name,score:gameScore,scoreLabel:"ç‚¹"});
  // 2) Save to local as fallback
  let all=await loadLocal("ranking-alltime");
  all.push({name,score:gameScore,ts});all.sort((a,b)=>b.score-a.score||a.ts-b.ts);all=all.slice(0,20);
  await saveLocal("ranking-alltime",all);
  const ws=getWeekStart();
  let week=await loadLocal("ranking-weekly");
  week=week.filter(e=>e.ts>=ws);week.push({name,score:gameScore,ts});week.sort((a,b)=>b.score-a.score||a.ts-b.ts);week=week.slice(0,20);
  await saveLocal("ranking-weekly",week);
  // 3) Fetch full ranking from GAS for display
  const gasRanking=await gasGet({action:"rankingByGame",gameId:GAME_ID});
  if(gasRanking&&gasRanking.ranking){
    const gasAll=gasRanking.ranking.slice(0,10);
    const gasWeek=gasRanking.ranking.filter(e=>{const d=parseGasDate(e.date);return d>=ws;}).slice(0,10);
    return{all:gasAll,week:gasWeek,source:"gas"};
  }
  // Fallback to local
  return{all:all.slice(0,10),week:week.slice(0,10),source:"local"};
}

async function fetchRankings(){
  // Try GAS first
  const gasRanking=await gasGet({action:"rankingByGame",gameId:GAME_ID});
  if(gasRanking&&gasRanking.ranking){
    const ws=getWeekStart();
    const gasAll=gasRanking.ranking.slice(0,10);
    const gasWeek=gasRanking.ranking.filter(e=>{const d=parseGasDate(e.date);return d>=ws;}).slice(0,10);
    return{all:gasAll,week:gasWeek,source:"gas"};
  }
  // Fallback
  const all=(await loadLocal("ranking-alltime")).slice(0,10);
  const ws=getWeekStart();
  let week=await loadLocal("ranking-weekly");
  week=week.filter(e=>e.ts>=ws).slice(0,10);
  return{all,week,source:"local"};
}

function parseGasDate(dateStr){
  if(!dateStr)return 0;
  // GAS format: "M/d H:mm" e.g. "2/18 14:30"
  const now=new Date();const y=now.getFullYear();
  const m=dateStr.match(/^(\d+)\/(\d+)\s+(\d+):(\d+)/);
  if(!m)return 0;
  return new Date(y,Number(m[1])-1,Number(m[2]),Number(m[3]),Number(m[4])).getTime();
}

/* â”€â”€ Small Components â”€â”€ */
function WafuDeco(){return(<>
  <div className="washi"/>
  <svg className="kumo kumo-1" viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg"><path d="M20 50Q20 20 50 20Q50 0 80 10Q100-5 120 10Q140 0 155 15Q180 10 185 35Q200 40 190 55Z" fill="currentColor"/></svg>
  <svg className="kumo kumo-2" viewBox="0 0 160 50" xmlns="http://www.w3.org/2000/svg"><path d="M10 40Q10 15 35 18Q45 0 70 8Q85-2 100 12Q120 5 130 22Q150 18 148 38Z" fill="currentColor"/></svg>
  <svg className="sakura sakura-1" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><g transform="translate(20,20)">{[0,72,144,216,288].map((a,i)=><path key={i} d="M0-11C-3-11-5.5-7-5-4C-5.5-2-3.5 0 0 0C3.5 0 5.5-2 5-4C5.5-7 3-11 0-11Z" fill="currentColor" transform={`rotate(${a})`}/>)}<circle r="3" fill="#f5d88a"/></g></svg>
  <svg className="sakura sakura-2" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><g transform="translate(20,20)">{[0,72,144,216,288].map((a,i)=><path key={i} d="M0-9C-2.5-9-4.5-6-4-3C-4.5-1.5-3 0 0 0C3 0 4.5-1.5 4-3C4.5-6 2.5-9 0-9Z" fill="currentColor" transform={`rotate(${a})`}/>)}<circle r="2.5" fill="#f5d88a"/></g></svg>
  <svg className="sakura sakura-3" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><g transform="translate(20,20)">{[0,72,144,216,288].map((a,i)=><path key={i} d="M0-7C-2-7-3.5-5-3-2.5C-3.5-1-2 0 0 0C2 0 3.5-1 3-2.5C3.5-5 2-7 0-7Z" fill="currentColor" transform={`rotate(${a})`}/>)}<circle r="2" fill="#f5d88a"/></g></svg>
  <svg className="sakura sakura-4" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><g transform="translate(20,20)">{[0,72,144,216,288].map((a,i)=><path key={i} d="M0-10C-2.8-10-5-6.5-4.5-3.5C-5-1.5-3 0 0 0C3 0 5-1.5 4.5-3.5C5-6.5 2.8-10 0-10Z" fill="currentColor" transform={`rotate(${a})`}/>)}<circle r="2.8" fill="#f5d88a"/></g></svg>
  <svg className="sakura sakura-5" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><g transform="translate(20,20)">{[0,72,144,216,288].map((a,i)=><path key={i} d="M0-6C-1.8-6-3-4-2.8-2C-3-0.8-1.8 0 0 0C1.8 0 3-0.8 2.8-2C3-4 1.8-6 0-6Z" fill="currentColor" transform={`rotate(${a})`}/>)}<circle r="1.8" fill="#f5d88a"/></g></svg>
  <svg className="sakura sakura-6" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><g transform="translate(20,20)">{[0,72,144,216,288].map((a,i)=><path key={i} d="M0-8C-2.2-8-4-5.5-3.5-3C-4-1.2-2.5 0 0 0C2.5 0 4-1.2 3.5-3C4-5.5 2.2-8 0-8Z" fill="currentColor" transform={`rotate(${a})`}/>)}<circle r="2.2" fill="#f5d88a"/></g></svg>
  <svg className="sakura sakura-7" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><g transform="translate(20,20)">{[0,72,144,216,288].map((a,i)=><path key={i} d="M0-7.5C-2-7.5-3.8-5-3.2-2.8C-3.8-1-2.2 0 0 0C2.2 0 3.8-1 3.2-2.8C3.8-5 2-7.5 0-7.5Z" fill="currentColor" transform={`rotate(${a})`}/>)}<circle r="2" fill="#f5d88a"/></g></svg>
</>);}
function Confetti(){const cols=["#7ecba1","#f2a1b3","#f5d88a","#f5a623","#64b5f6","#ce93d8","#ff8a65","#4dd0e1"];const ps=useRef(Array.from({length:40},(_,i)=>({id:i,x:Math.random()*100,c:cols[i%cols.length],d:Math.random()*0.5,sz:Math.random()*8+4,dr:(Math.random()-0.5)*120,sh:Math.random()>0.5?"50%":"2px"}))).current;return(<div style={{position:"fixed",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:9999,overflow:"hidden"}}>{ps.map(p=><div key={p.id} style={{position:"absolute",left:`${p.x}%`,top:"-10px",width:p.sz,height:p.sz,background:p.c,borderRadius:p.sh,animation:`confettiFall 1.4s ${p.d}s ease-out forwards`,["--drift"]:`${p.dr}px`}}/>)}</div>);}
function ComboChar({streak}){const f=["ğŸ˜Š","ğŸ˜„","ğŸ¤©","ğŸ”¥","âš¡","ğŸŒŸ"][Math.min(streak-1,5)];return(<div className="combo-char" style={{display:"flex",alignItems:"center",justifyContent:"center",gap:6,animation:"comboBounce 0.5s ease",fontWeight:800,color:C.orange}}><span className="combo-emoji" style={{animation:streak>=5?"comboSpin 0.6s ease":"comboBounce 0.4s ease"}}>{f}</span><span>ğŸ”¥ {streak}ã‚³ãƒ³ãƒœï¼</span></div>);}
function ScoreFloat({amount}){return(<div className="score-float-text" style={{position:"fixed",top:"42%",left:"50%",transform:"translate(-50%,-50%)",fontWeight:900,color:C.orange,pointerEvents:"none",zIndex:9998,animation:"scoreFloat 0.7s ease forwards",textShadow:"0 2px 6px rgba(245,166,35,0.3)"}}>+{amount}</div>);}
function AltBadge({total}){return(<div className="alt-badge" style={{display:"inline-flex",alignItems:"center",gap:6,background:C.cream,border:`2px solid ${C.creamDark}`,borderRadius:20,padding:"6px 14px",boxShadow:"0 2px 10px rgba(245,166,35,0.15)"}}><span>ğŸª™</span><span style={{fontWeight:900,color:C.orange}}>{total}</span><span style={{fontWeight:700,color:C.textSoft}}>ALT</span></div>);}
function ProgBar({cur,tot}){return(<div style={{width:"100%",height:10,background:C.bgSoft,borderRadius:5,overflow:"hidden",marginBottom:16,border:`1px solid ${C.cardBorder}`}}><div style={{width:`${(cur/tot)*100}%`,height:"100%",background:`linear-gradient(90deg,${C.mint},${C.mintDark})`,borderRadius:5,transition:"width 0.4s ease"}}/></div>);}
function TimerBar({rem,tot}){const u=rem<=15;return(<div style={{width:"100%",marginBottom:16}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:4,fontWeight:700}} className="timer-text"><span style={{color:u?C.pinkDark:C.orange}}>â± ã®ã“ã‚Š {rem}ç§’</span></div><div style={{width:"100%",height:10,background:C.bgSoft,borderRadius:5,overflow:"hidden",border:`1px solid ${C.cardBorder}`}}><div style={{width:`${(rem/tot)*100}%`,height:"100%",borderRadius:5,transition:"width 0.3s linear",background:u?`linear-gradient(90deg,${C.pink},${C.pinkDark})`:`linear-gradient(90deg,${C.creamDark},${C.orange})`,animation:u?"pulse 0.5s infinite":"none"}}/></div></div>);}

/* â”€â”€ Hints â”€â”€ */
function SakuranboHint({q}){const{a,b,part1:p1,part2:p2,roundA:rA,answer:ans}=q;const hn=(v,bg,clr,bc)=><span style={{display:"inline-flex",alignItems:"center",justifyContent:"center",minWidth:36,padding:"3px 8px",borderRadius:8,background:bg,color:clr,fontWeight:900,fontSize:18,border:`2px solid ${bc}`}}>{v}</span>;
  return(<div className="hint-box" style={{background:C.cherryLight,borderRadius:20,padding:"18px 16px 14px",marginTop:14,border:`3px solid ${C.pink}`,width:"100%",margin:"14px auto 0",animation:"slideUp 0.3s ease"}}><div style={{background:C.cherry,borderRadius:10,padding:"5px 14px",marginBottom:14,textAlign:"center"}}><span style={{color:"#fff",fontWeight:900,letterSpacing:1}} className="hint-title">ğŸ’ ã•ãã‚‰ã‚“ã¼è¨ˆç®—</span></div>
    <div style={{textAlign:"center",marginBottom:8}}><span className="hint-big-num" style={{fontWeight:900,color:C.text}}>{a}</span><span className="hint-op" style={{fontWeight:800,color:C.textSoft,margin:"0 6px"}}>+</span><span className="hint-big-num" style={{fontWeight:900,color:C.cherry}}>{b}</span><span className="hint-op" style={{fontWeight:800,color:C.textSoft,margin:"0 6px"}}>=</span><span className="hint-answer" style={{display:"inline-flex",alignItems:"center",justifyContent:"center",minWidth:48,padding:"4px 12px",borderRadius:12,background:"linear-gradient(135deg,#ffe082,#ffca28)",color:C.text,fontWeight:900,border:"3px solid #f9a825"}}>{ans}</span></div>
    <div style={{display:"flex",flexDirection:"column",alignItems:"center"}}><svg width="140" height="50" viewBox="0 0 140 50"><line x1="70" y1="0" x2="40" y2="42" stroke={C.cherry} strokeWidth="3"/><line x1="70" y1="0" x2="100" y2="42" stroke={C.cherry} strokeWidth="3"/></svg><div style={{display:"flex",gap:32,marginTop:-8}}>{[p1,p2].map((v,i)=><div key={i} style={{width:44,height:44,borderRadius:"50%",background:C.cherry,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontWeight:900,fontSize:18,boxShadow:"0 3px 10px rgba(229,57,53,0.3)"}}>{v}</div>)}</div></div>
    <div style={{marginTop:12,display:"flex",flexDirection:"column",gap:4,alignItems:"center"}}><div style={{fontSize:12,color:C.textSoft,fontWeight:600}}><span style={{color:C.cherry,fontWeight:800}}>{b}</span> ã‚’ {p1} ã¨ {p2} ã«åˆ†ã‘ã‚‹</div><div style={{color:C.textMuted,fontSize:13}}>â†“</div><div style={{display:"flex",alignItems:"center",gap:4}}>{hn(a,"#fff",C.text,C.mint)}<span style={{fontWeight:800,color:C.textSoft}}>+</span>{hn(p1,C.cherryLight,C.cherry,C.cherry)}<span style={{fontWeight:800,color:C.textSoft}}>=</span>{hn(rA,C.mintLight,C.mintDark,C.mint)}</div><div style={{color:C.textMuted,fontSize:13}}>â†“</div><div style={{display:"flex",alignItems:"center",gap:4}}>{hn(rA,C.mintLight,C.mintDark,C.mint)}<span style={{fontWeight:800,color:C.textSoft}}>+</span>{hn(p2,C.cherryLight,C.cherry,C.cherry)}<span style={{fontWeight:800,color:C.textSoft}}>=</span><span style={{display:"inline-flex",alignItems:"center",justifyContent:"center",minWidth:48,padding:"4px 12px",borderRadius:10,background:"linear-gradient(135deg,#ffe082,#ffca28)",color:C.text,fontWeight:900,fontSize:22,border:"3px solid #f9a825"}}>{ans}</span></div></div></div>);}

function OmiyageHint({a,b}){const oA=a-10,oB=b-10,sL=a+oB,p1=sL*10,p2=oA*oB,tot=p1+p2;const nb=(v,ac)=><span className="hint-num" style={{display:"inline-flex",alignItems:"center",justifyContent:"center",minWidth:40,padding:"4px 10px",borderRadius:10,background:ac?C.orangeLight:"#fff",color:ac?"#d4790e":C.text,fontWeight:900,border:`2.5px solid ${ac?C.orange:C.mint}`}}>{v}</span>;const op=t=><span className="hint-op" style={{fontWeight:800,color:C.textSoft,margin:"0 4px"}}>{t}</span>;const sn=t=><span style={{fontSize:10,color:C.textSoft,fontWeight:600}}>{t}</span>;
  return(<div className="hint-box" style={{background:C.mintLight,borderRadius:20,padding:"18px 16px 14px",marginTop:14,border:`3px solid ${C.mint}`,width:"100%",margin:"14px auto 0",animation:"slideUp 0.3s ease"}}><div style={{background:C.mint,borderRadius:10,padding:"5px 14px",marginBottom:14,textAlign:"center"}}><span style={{color:"#fff",fontWeight:900,letterSpacing:1}} className="hint-title">ğŸ ãŠã¿ã‚„ã’ç®—</span></div>
    <div style={{display:"flex",alignItems:"flex-start",justifyContent:"center",gap:8,marginBottom:2}}><div style={{display:"flex",flexDirection:"column",alignItems:"center"}}><svg width="120" height="30" viewBox="0 0 120 30" style={{marginBottom:-4}}><defs><marker id="oA" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#d4790e"/></marker></defs><path d="M88 26C88 6,32 6,32 26" fill="none" stroke="#d4790e" strokeWidth="2.5" markerEnd="url(#oA)"/></svg><div style={{display:"flex",alignItems:"baseline",gap:6}}><span className="hint-big-num" style={{fontWeight:900,color:C.text}}>{a}</span><span className="hint-op" style={{fontWeight:800,color:C.textSoft}}>Ã—</span><span className="hint-big-num" style={{fontWeight:900,color:C.text}}>{b}</span></div></div><div style={{background:C.orangeLight,borderRadius:10,padding:"4px 10px",border:`1.5px solid ${C.orange}`,fontSize:11,color:"#d4790e",fontWeight:700,lineHeight:1.4,textAlign:"center",marginTop:14}}>ãŠã¿ã‚„ã’ã®<br/><b style={{fontSize:15}}>{oB}</b> ã‚’ã‚ãŸã™</div></div>
    <div style={{display:"flex",justifyContent:"center",gap:24,marginTop:8,marginBottom:4}}><div style={{textAlign:"center"}}>{sn(`${a}+${oB}`)}<div style={{color:C.textMuted,fontSize:13}}>â†“</div></div><div style={{textAlign:"center"}}>{sn(`${b}âˆ’${oB}`)}<div style={{color:C.textMuted,fontSize:13}}>â†“</div></div><div style={{textAlign:"center"}}>{sn(`${a}ã¨${b}ã®`)}<div style={{fontSize:10,color:C.textSoft,fontWeight:600}}>ä¸€ã®ä½ã‚’ã‹ã‘ã‚‹</div></div></div>
    <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:3,flexWrap:"wrap",marginBottom:4}}>{op("=")}{nb(sL)}{op("Ã—")}{nb(10)}{op("+")}{nb(oA,1)}{op("Ã—")}{nb(oB,1)}</div><div style={{textAlign:"center",color:C.textMuted,fontSize:14,margin:"4px 0"}}>â†“</div><div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:3,marginBottom:4}}>{op("=")}{nb(p1)}{op("+")}{nb(p2,1)}</div><div style={{textAlign:"center",color:C.textMuted,fontSize:14,margin:"4px 0"}}>â†“</div><div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:8}}>{op("=")}<span className="hint-answer" style={{display:"inline-flex",alignItems:"center",justifyContent:"center",minWidth:64,padding:"6px 16px",borderRadius:12,background:"linear-gradient(135deg,#ffe082,#ffca28)",color:C.text,fontWeight:900,border:"3px solid #f9a825"}}>{tot}</span></div></div>);}
function HintFor({q,lv}){if(lv.type==="sakuranbo")return <SakuranboHint q={q}/>;if(lv.type==="sakuranbo_sub")return <SakuranboSubHint q={q}/>;return <OmiyageHint a={q.a} b={q.b}/>;}

/* â”€â”€ Sakuranbo Subtraction Hint â”€â”€ */
function SakuranboSubHint({q}){const{a,b,part1:p1,part2:p2,roundA:rA,answer:ans}=q;const hn=(v,bg,clr,bc)=><span style={{display:"inline-flex",alignItems:"center",justifyContent:"center",minWidth:36,padding:"3px 8px",borderRadius:8,background:bg,color:clr,fontWeight:900,fontSize:18,border:`2px solid ${bc}`}}>{v}</span>;
  return(<div className="hint-box" style={{background:C.cherryLight,borderRadius:20,padding:"18px 16px 14px",marginTop:14,border:`3px solid ${C.pink}`,width:"100%",margin:"14px auto 0",animation:"slideUp 0.3s ease"}}>
    <div style={{background:"#c62828",borderRadius:10,padding:"5px 14px",marginBottom:14,textAlign:"center"}}><span style={{color:"#fff",fontWeight:900,letterSpacing:1}} className="hint-title">ğŸ’ ã•ãã‚‰ã‚“ã¼å¼•ãç®—</span></div>
    <div style={{textAlign:"center",marginBottom:8}}><span className="hint-big-num" style={{fontWeight:900,color:C.text}}>{a}</span><span className="hint-op" style={{fontWeight:800,color:C.textSoft,margin:"0 6px"}}>âˆ’</span><span className="hint-big-num" style={{fontWeight:900,color:C.cherry}}>{b}</span><span className="hint-op" style={{fontWeight:800,color:C.textSoft,margin:"0 6px"}}>=</span><span className="hint-answer" style={{display:"inline-flex",alignItems:"center",justifyContent:"center",minWidth:48,padding:"4px 12px",borderRadius:12,background:"linear-gradient(135deg,#ffe082,#ffca28)",color:C.text,fontWeight:900,border:"3px solid #f9a825"}}>{ans}</span></div>
    <div style={{display:"flex",flexDirection:"column",alignItems:"center"}}><svg width="140" height="50" viewBox="0 0 140 50"><line x1="70" y1="0" x2="40" y2="42" stroke={C.cherry} strokeWidth="3"/><line x1="70" y1="0" x2="100" y2="42" stroke={C.cherry} strokeWidth="3"/></svg><div style={{display:"flex",gap:32,marginTop:-8}}>{[p1,p2].map((v,i)=><div key={i} style={{width:44,height:44,borderRadius:"50%",background:C.cherry,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontWeight:900,fontSize:18,boxShadow:"0 3px 10px rgba(229,57,53,0.3)"}}>{v}</div>)}</div></div>
    <div style={{marginTop:12,display:"flex",flexDirection:"column",gap:4,alignItems:"center"}}><div style={{fontSize:12,color:C.textSoft,fontWeight:600}}><span style={{color:C.cherry,fontWeight:800}}>{b}</span> ã‚’ <span style={{fontWeight:800}}>{p1}</span> ã¨ <span style={{fontWeight:800}}>{p2}</span> ã«åˆ†ã‘ã‚‹</div><div style={{color:C.textMuted,fontSize:13}}>â†“</div>
    <div style={{display:"flex",alignItems:"center",gap:4}}>{hn(a,"#fff",C.text,C.mint)}<span style={{fontWeight:800,color:C.textSoft}}>âˆ’</span>{hn(p1,C.cherryLight,C.cherry,C.cherry)}<span style={{fontWeight:800,color:C.textSoft}}>=</span>{hn(rA,C.mintLight,C.mintDark,C.mint)}</div>
    <div style={{color:C.textMuted,fontSize:13}}>â†“</div>
    <div style={{display:"flex",alignItems:"center",gap:4}}>{hn(rA,C.mintLight,C.mintDark,C.mint)}<span style={{fontWeight:800,color:C.textSoft}}>âˆ’</span>{hn(p2,C.cherryLight,C.cherry,C.cherry)}<span style={{fontWeight:800,color:C.textSoft}}>=</span><span style={{display:"inline-flex",alignItems:"center",justifyContent:"center",minWidth:48,padding:"4px 12px",borderRadius:10,background:"linear-gradient(135deg,#ffe082,#ffca28)",color:C.text,fontWeight:900,fontSize:22,border:"3px solid #f9a825"}}>{ans}</span></div></div>
  </div>);}

/* â”€â”€ Ranking Table â”€â”€ */
function RankingTable({data,myName,label}){const medals=["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"];const unit=label||"ç‚¹";
  if(!data||data.length===0)return <div style={{textAlign:"center",padding:20,color:C.textMuted,fontSize:13}}>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>;
  return(<div style={{width:"100%"}}>{data.map((e,i)=>{const n=e.player||e.name;const sc=e.score;const isMe=myName&&n===myName;return(
    <div key={i} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 12px",borderRadius:12,marginBottom:4,background:isMe?C.cream:i%2===0?C.bg:"transparent",border:isMe?`2px solid ${C.creamDark}`:"2px solid transparent",transition:"all 0.2s"}}>
      <span style={{width:32,textAlign:"center",fontSize:i<3?20:14,fontWeight:800,color:i<3?C.orange:C.textSoft}}>{i<3?medals[i]:i+1}</span>
      <span style={{flex:1,fontWeight:isMe?800:600,color:C.text,fontSize:15}}>{n}{isMe&&" ğŸ‘ˆ"}</span>
      <span style={{fontWeight:900,color:C.mintDark,fontSize:16}}>{sc}{unit}</span>
    </div>);})}</div>);}

/* â”€â”€ Ranking Screen â”€â”€ */
function RankingScreen({onBack}){
  const[tab,setTab]=useState("week");const[data,setData]=useState({all:[],week:[]});const[loading,setLoading]=useState(true);const[src,setSrc]=useState("");
  useEffect(()=>{fetchRankings().then(d=>{setData(d);setSrc(d.source||"");setLoading(false);});},[]);
  const tabStyle=(t)=>({flex:1,padding:"10px",borderRadius:12,border:"none",fontWeight:700,fontSize:14,cursor:"pointer",transition:"all 0.2s",background:tab===t?C.mint:"transparent",color:tab===t?"#fff":C.textSoft});
  return(
    <div className="omiyage-root screen-ranking" style={{minHeight:"100vh",background:C.bg,display:"flex",flexDirection:"column",alignItems:"center",padding:20,color:C.text}}>
      <WafuDeco/>
      <div className="game-header" style={{width:"100%",display:"flex",alignItems:"center",marginBottom:16}}>
        <button onClick={onBack} style={{background:"none",border:"none",color:C.textSoft,cursor:"pointer",padding:"4px 8px"}} className="back-btn">â† ã‚‚ã©ã‚‹</button>
      </div>
      <div style={{textAlign:"center",marginBottom:16}}><span style={{fontSize:28}}>ğŸ†</span><h2 className="title-heading" style={{fontWeight:900,color:C.orange,margin:"4px 0",fontSize:24}}>ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2><p style={{fontSize:13,color:C.textSoft}}>60ç§’ã§ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ç›®æŒ‡ã›ï¼</p></div>
      <div className="ranking-card" style={{width:"100%",background:C.card,borderRadius:20,padding:"16px",border:`2px solid ${C.cardBorder}`,boxShadow:"0 4px 20px rgba(0,0,0,0.05)"}}>
        <div style={{display:"flex",gap:4,marginBottom:12,background:C.bgSoft,borderRadius:14,padding:3}}>
          <button onClick={()=>setTab("week")} style={tabStyle("week")}>ğŸ“… ä»Šé€±</button>
          <button onClick={()=>setTab("all")} style={tabStyle("all")}>ğŸ‘‘ æ°¸ä¹…</button>
        </div>
        {loading?<div style={{textAlign:"center",padding:20,color:C.textMuted}}>èª­ã¿è¾¼ã¿ä¸­...</div>:<RankingTable data={tab==="week"?data.week:data.all}/>}
        {src==="local"&&<div style={{textAlign:"center",fontSize:10,color:C.textMuted,marginTop:8}}>âš  ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿</div>}
      </div>
      <style>{GS}</style>
    </div>
  );}

/* â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â• */
function OmiyageGame(){
  const[screen,setScreen]=useState("title");
  const[currentLevel,setCurrentLevel]=useState(0);
  const[question,setQuestion]=useState(null);
  const[selectedAnswer,setSelectedAnswer]=useState(null);
  const[questionNum,setQuestionNum]=useState(0);
  const[correctCount,setCorrectCount]=useState(0);
  const[totalCorrect,setTotalCorrect]=useState(0);
  const[feedback,setFeedback]=useState(null);
  const[showHint,setShowHint]=useState(false);
  const[streak,setStreak]=useState(0);
  const[bestStreak,setBestStreak]=useState(0);
  const[completedLevels,setCompletedLevels]=useState([]);
  const[startTime,setStartTime]=useState(null);
  const[elapsed,setElapsed]=useState(0);
  const[shakeWrong,setShakeWrong]=useState(false);
  const[praiseText,setPraiseText]=useState("");
  const[timeRemaining,setTimeRemaining]=useState(0);
  const[answered,setAnswered]=useState(0);
  const[showConfetti,setShowConfetti]=useState(false);
  const[slideKey,setSlideKey]=useState(0);
  const[timeBonus,setTimeBonus]=useState(null);
  const[altTotal,setAltTotal]=useState(0);
  const[resultBd,setResultBd]=useState(null);
  const[score,setScore]=useState(0);
  const[scoreFloat,setScoreFloat]=useState(null);
  // Ranking states
  const[rankName,setRankName]=useState("");
  const[rankSubmitted,setRankSubmitted]=useState(false);
  const[rankSubmitting,setRankSubmitting]=useState(false);
  const[rankResult,setRankResult]=useState(null); // {rank, data}
  const[rankTab,setRankTab]=useState("week");

  const timerRef=useRef(null);const autoRef=useRef(null);const countdownRef=useRef(null);const bonusRef=useRef(null);const sfRef=useRef(null);
  const level=LEVELS[currentLevel];const isTA=!!level?.timeAttack;const totalQ=level?.count||10;
  const PR=["ã™ã”ã„ï¼","ã‹ã‚“ãºãï¼","å¤©æ‰ï¼","ãƒãƒƒãƒãƒªï¼","ãƒŠã‚¤ã‚¹ï¼","ãã®èª¿å­ï¼","ã‚µã‚¤ã‚³ãƒ¼ï¼","ã‚„ã£ãŸã­ï¼"];

  const showSF=n=>{clearTimeout(sfRef.current);setScoreFloat(n);sfRef.current=setTimeout(()=>setScoreFloat(null),700);};
  const showTB=(v,t)=>{clearTimeout(bonusRef.current);setTimeBonus({v,t});bonusRef.current=setTimeout(()=>setTimeBonus(null),800);};

  const finishGame=useCallback(()=>{
    clearInterval(timerRef.current);clearInterval(countdownRef.current);clearTimeout(autoRef.current);
    const stars=getStars(correctCount,isTA?answered:totalQ,isTA);const ca=getClearAlt(stars);
    const isFirst=stars>=1&&!completedLevels.includes(currentLevel);const fa=isFirst?FIRST_CLEAR_ALT:0;
    setAltTotal(p=>p+ca+fa);
    setResultBd({clearAlt:ca,firstAlt:fa,totalAltEarned:ca+fa,stars,isFirst});
    if(stars>=1)setCompletedLevels(p=>p.includes(currentLevel)?p:[...p,currentLevel]);
    setRankSubmitted(false);setRankSubmitting(false);setRankResult(null);setRankName("");setRankTab("week");
    setScreen("result");
  },[currentLevel,correctCount,isTA,totalQ,answered,completedLevels]);

  const goNext=useCallback(()=>{
    const n=questionNum+1;if(n>=totalQ){finishGame();return;}
    setSlideKey(k=>k+1);setQuestionNum(n);setQuestion(genQ(LEVELS[currentLevel]));
    setSelectedAnswer(null);setFeedback(null);setShowHint(false);setShowConfetti(false);
  },[questionNum,totalQ,currentLevel,finishGame]);

  const startLevel=useCallback(lvl=>{
    setCurrentLevel(lvl);setQuestionNum(0);setCorrectCount(0);setAnswered(0);setScore(0);
    setFeedback(null);setSelectedAnswer(null);setShowHint(false);setShowConfetti(false);setTimeBonus(null);
    setStartTime(Date.now());setElapsed(0);setPraiseText("");setSlideKey(0);setScoreFloat(null);setResultBd(null);
    if(LEVELS[lvl].timeAttack)setTimeRemaining(LEVELS[lvl].timeAttack);
    setQuestion(genQ(LEVELS[lvl]));setScreen("game");
  },[]);

  useEffect(()=>{if(screen==="game"&&startTime&&!isTA){timerRef.current=setInterval(()=>setElapsed(Math.floor((Date.now()-startTime)/1000)),200);return()=>clearInterval(timerRef.current);}},[screen,startTime,isTA]);
  useEffect(()=>{if(screen==="game"&&isTA&&startTime){countdownRef.current=setInterval(()=>{setTimeRemaining(p=>{if(p<=1){clearInterval(countdownRef.current);setTimeout(()=>finishGame(),300);return 0;}return p-1;});setElapsed(e=>e+1);},1000);return()=>clearInterval(countdownRef.current);}},[screen,isTA,startTime,finishGame]);
  useEffect(()=>{if(feedback==="correct"){autoRef.current=setTimeout(()=>goNext(),isTA?600:1000);return()=>clearTimeout(autoRef.current);}},[feedback,goNext,isTA]);

  const handleChoice=v=>{
    if(feedback)return;if(isTA&&timeRemaining<=0)return;
    setSelectedAnswer(v);setAnswered(a=>a+1);
    if(v===question.answer){const ns=streak+1;setCorrectCount(c=>c+1);setTotalCorrect(c=>c+1);setStreak(ns);setBestStreak(b=>Math.max(b,ns));setPraiseText(PR[rng(0,PR.length-1)]);setFeedback("correct");setShowConfetti(true);setTimeout(()=>setShowConfetti(false),1500);const pts=getScorePts(ns);setScore(s=>s+pts);showSF(pts);if(isTA&&ns>=4){setTimeRemaining(t=>t+1);showTB("+1","bonus");}}
    else{setStreak(0);setShakeWrong(true);setTimeout(()=>setShakeWrong(false),500);setFeedback("wrong");if(isTA){setTimeRemaining(t=>Math.max(0,t-2));showTB("-2","penalty");setTimeout(()=>goNext(),1200);}}
  };

  const handleRankSubmit=async()=>{
    if(!rankName.trim())return;
    setRankSubmitting(true);
    const ts=Date.now();const res=await submitScore(rankName.trim(),score,ts);
    const findRank=(list)=>{const nm=rankName.trim();const idx=list.findIndex(e=>(e.player||e.name)===nm);return idx>=0?idx+1:null;};
    setRankResult({weekRank:findRank(res.week),allRank:findRank(res.all),data:res});
    setRankSubmitted(true);setRankSubmitting(false);
  };

  const fmt=s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;
  const cSt=v=>{const b={padding:"18px 8px",borderRadius:16,fontWeight:800,width:"100%",cursor:"pointer",transition:"all 0.25s",outline:"none"};if(!feedback)return{...b,background:"#fff",border:`2px solid ${C.cardBorder}`,color:C.text,boxShadow:"0 2px 8px rgba(0,0,0,0.04)"};if(v===question.answer)return{...b,background:C.correctBg,border:`3px solid ${C.correct}`,color:C.mintDark,boxShadow:"0 0 20px rgba(107,196,143,0.3)",transform:"scale(1.04)",cursor:"default"};if(v===selectedAnswer)return{...b,background:C.wrongGreyBg,border:`3px solid ${C.wrongGrey}`,color:C.textMuted,textDecoration:"line-through",textDecorationThickness:"3px",cursor:"default"};return{...b,background:C.bg,border:"2px solid transparent",color:C.textMuted,cursor:"default",opacity:0.4};};
  const qD=question?(level.type==="sakuranbo"?`${question.a} + ${question.b}`:level.type==="sakuranbo_sub"?`${question.a} âˆ’ ${question.b}`:`${question.a} Ã— ${question.b}`):"";

  /* â”€â”€ RANKING SCREEN â”€â”€ */
  if(screen==="ranking")return <RankingScreen onBack={()=>setScreen("title")}/>;

  /* â”€â”€ TITLE â”€â”€ */
  if(screen==="title"){return(
    <div className="omiyage-root screen-title" style={{minHeight:"100vh",background:C.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:20,color:C.text}}>
      <WafuDeco/>
      <div style={{marginBottom:16,animation:"fadeInUp 0.4s ease"}}><AltBadge total={altTotal}/></div>
      <div className="title-emoji" style={{marginBottom:8,animation:"floatBounce 2s ease-in-out infinite"}}>ğŸ</div>
      <h1 className="title-heading" style={{fontWeight:900,color:C.mintDark,marginBottom:4,textAlign:"center",animation:"fadeInUp 0.6s ease"}}>ãŠã¿ã‚„ã’ç®—</h1>
      <p className="title-sub" style={{color:C.textSoft,marginBottom:28,textAlign:"center",animation:"fadeInUp 0.6s 0.1s ease both"}}>ã•ãã‚‰ã‚“ã¼è¨ˆç®— &amp; æš—ç®—ãƒã‚¹ã‚¿ãƒ¼ï¼</p>
      <div className="section-label" style={{width:"100%",textAlign:"center",marginBottom:8}}><span style={{background:C.cherryLight,color:C.cherry,fontWeight:800,padding:"4px 16px",borderRadius:20,border:`2px solid ${C.pink}`,fontSize:13}}>ğŸ’ ã•ãã‚‰ã‚“ã¼è¨ˆç®—ï¼ˆãŸã—ç®—ï¼‰</span></div>
      <div className="level-grid level-grid-sakuranbo" style={{display:"grid",gap:10,width:"100%",marginBottom:20}}>
        {LEVELS.slice(0,3).map((lv,i)=>{const done=completedLevels.includes(i);return(<button key={i} onClick={()=>startLevel(i)} className="level-btn" style={{padding:"16px 10px",borderRadius:16,border:done?`2.5px solid ${C.creamDark}`:`2px solid ${C.cardBorder}`,background:done?C.cream:C.card,color:C.text,cursor:"pointer",textAlign:"center",transition:"all 0.2s",position:"relative",boxShadow:"0 2px 8px rgba(0,0,0,0.04)",animation:`fadeInUp 0.4s ${0.05*i}s ease both`}} onMouseEnter={e=>{e.currentTarget.style.transform="translateY(-3px)";}} onMouseLeave={e=>{e.currentTarget.style.transform="translateY(0)";}}>{done&&<span style={{position:"absolute",top:6,right:8,fontSize:14}}>â­</span>}<div className="level-name" style={{fontWeight:700,marginBottom:2}}>{lv.name}</div><div className="level-label" style={{color:C.textSoft}}>{lv.label}</div></button>);})}
      </div>
      <div className="section-label" style={{width:"100%",textAlign:"center",marginBottom:8}}><span style={{background:C.cherryLight,color:"#c62828",fontWeight:800,padding:"4px 16px",borderRadius:20,border:`2px solid #c62828`,fontSize:13}}>ğŸ’ ã•ãã‚‰ã‚“ã¼è¨ˆç®—ï¼ˆã²ãç®—ï¼‰</span></div>
      <div className="level-grid level-grid-sakuranbo" style={{display:"grid",gap:10,width:"100%",marginBottom:20}}>
        {LEVELS.slice(3,6).map((lv,idx)=>{const i=idx+3;const done=completedLevels.includes(i);return(<button key={i} onClick={()=>startLevel(i)} className="level-btn" style={{padding:"16px 10px",borderRadius:16,border:done?`2.5px solid ${C.creamDark}`:`2px solid ${C.cardBorder}`,background:done?C.cream:C.card,color:C.text,cursor:"pointer",textAlign:"center",transition:"all 0.2s",position:"relative",boxShadow:"0 2px 8px rgba(0,0,0,0.04)",animation:`fadeInUp 0.4s ${0.03*i}s ease both`}} onMouseEnter={e=>{e.currentTarget.style.transform="translateY(-3px)";}} onMouseLeave={e=>{e.currentTarget.style.transform="translateY(0)";}}>{done&&<span style={{position:"absolute",top:6,right:8,fontSize:14}}>â­</span>}<div className="level-name" style={{fontWeight:700,marginBottom:2}}>{lv.name}</div><div className="level-label" style={{color:C.textSoft}}>{lv.label}</div></button>);})}
      </div>
      <div className="section-label" style={{width:"100%",textAlign:"center",marginBottom:8}}><span style={{background:C.mintLight,color:C.mintDark,fontWeight:800,padding:"4px 16px",borderRadius:20,border:`2px solid ${C.mint}`,fontSize:13}}>ğŸ ãŠã¿ã‚„ã’ç®—</span></div>
      <div className="level-grid level-grid-omiyage" style={{display:"grid",gap:10,width:"100%",marginBottom:20}}>
        {LEVELS.slice(6).map((lv,idx)=>{const i=idx+6;const done=completedLevels.includes(i);const ta=!!lv.timeAttack;return(<button key={i} onClick={()=>startLevel(i)} className={`level-btn${ta?" level-ta":""}`} style={{padding:"16px 10px",borderRadius:16,border:done?`2.5px solid ${C.creamDark}`:`2px solid ${C.cardBorder}`,background:ta?`linear-gradient(135deg,${C.pinkLight},${C.cream})`:done?C.cream:C.card,color:C.text,cursor:"pointer",textAlign:"center",transition:"all 0.2s",position:"relative",boxShadow:"0 2px 8px rgba(0,0,0,0.04)",animation:`fadeInUp 0.4s ${0.03*i}s ease both`}} onMouseEnter={e=>{e.currentTarget.style.transform="translateY(-3px)";}} onMouseLeave={e=>{e.currentTarget.style.transform="translateY(0)";}}>{done&&<span style={{position:"absolute",top:6,right:8,fontSize:14}}>â­</span>}<div className="level-name" style={{fontWeight:700,marginBottom:2,color:ta?C.pinkDark:C.text}}>{ta?"â± ":""}{lv.name}</div><div className="level-label" style={{color:C.textSoft}}>{lv.label}</div>{ta&&<button onClick={e=>{e.stopPropagation();setScreen("ranking");}} style={{marginTop:6,background:C.cream,border:`1.5px solid ${C.creamDark}`,borderRadius:10,padding:"3px 10px",fontSize:11,fontWeight:700,color:C.orange,cursor:"pointer"}}>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>}</button>);})}
      </div>
      {totalCorrect>0&&<div className="stats-line" style={{color:C.textMuted,textAlign:"center",marginBottom:8}}>ç´¯è¨ˆæ­£è§£: {totalCorrect}å• ï½œ æœ€é«˜é€£ç¶š: {bestStreak}</div>}
      <style>{GS}</style>
    </div>);}

  /* â”€â”€ GAME â”€â”€ */
  if(screen==="game"){return(
    <div className="omiyage-root screen-game" style={{minHeight:"100vh",background:C.bg,display:"flex",flexDirection:"column",alignItems:"center",padding:"20px 16px 40px",color:C.text}}>
      <WafuDeco/>
      {showConfetti&&<Confetti/>}{scoreFloat&&<ScoreFloat amount={scoreFloat}/>}
      <div className="game-header" style={{width:"100%",display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
        <button onClick={()=>{clearTimeout(autoRef.current);clearInterval(countdownRef.current);setScreen("title");}} style={{background:"none",border:"none",color:C.textSoft,cursor:"pointer",padding:"4px 8px"}} className="back-btn">â† ã‚‚ã©ã‚‹</button>
        <div style={{display:"flex",alignItems:"center",gap:12}}><span className="score-display" style={{fontWeight:800,color:C.orange}}>{score}ç‚¹</span>{!isTA&&<span className="elapsed" style={{color:C.textSoft}}>{fmt(elapsed)}</span>}</div>
      </div>
      <div className="game-info" style={{width:"100%"}}><div className="game-meta" style={{display:"flex",justifyContent:"space-between",marginBottom:6,color:C.textSoft}}><span>{level.name}</span><span>{isTA?`${correctCount}å•æ­£è§£`:`${questionNum+1}/${totalQ}`}</span></div>
        {isTA?<div style={{position:"relative"}}><TimerBar rem={timeRemaining} tot={level.timeAttack}/>{timeBonus&&<div key={Date.now()} style={{position:"absolute",top:-2,right:0,fontWeight:900,color:timeBonus.t==="bonus"?C.mintDark:C.pinkDark,animation:"timeBonusPop 0.8s ease forwards",pointerEvents:"none"}} className="time-bonus">{timeBonus.v}ç§’</div>}</div>:<ProgBar cur={questionNum+(feedback?1:0)} tot={totalQ}/>}
      </div>
      {streak>=3&&!feedback&&<ComboChar streak={streak}/>}
      <div key={slideKey} className="question-card" style={{width:"100%",background:C.card,borderRadius:24,padding:"32px 18px 24px",textAlign:"center",border:`2px solid ${C.cardBorder}`,boxShadow:"0 4px 20px rgba(0,0,0,0.05)",marginTop:8,animation:shakeWrong?"shake 0.4s":"slideIn 0.35s ease"}}>
        <div className="question-num" style={{fontWeight:900,letterSpacing:2,marginBottom:20,color:C.text,animation:"fadeInScale 0.3s ease"}}>{qD}</div>
        <div className="choices-grid" style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:12}}>
          {question.choices.map((val,i)=>(<button key={`${slideKey}-${i}`} onClick={()=>handleChoice(val)} disabled={!!feedback} className="choice-btn" style={{...cSt(val),animation:!feedback?`choiceAppear 0.3s ${0.06*i}s ease both`:undefined}} onMouseEnter={e=>{if(!feedback){e.currentTarget.style.background=C.mintLight;e.currentTarget.style.transform="translateY(-3px)";e.currentTarget.style.borderColor=C.mint;}}} onMouseLeave={e=>{if(!feedback){e.currentTarget.style.background="#fff";e.currentTarget.style.transform="translateY(0)";e.currentTarget.style.borderColor=C.cardBorder;}}}>{val}</button>))}
        </div>
        {feedback==="correct"&&<div style={{animation:"popIn 0.25s ease",marginTop:4}}><span className="praise" style={{fontWeight:800,color:C.mintDark}}>ğŸ‰ {praiseText}</span></div>}
        {feedback==="wrong"&&(<div style={{marginTop:8,animation:"slideUp 0.3s ease"}}><div className="wrong-answer" style={{fontWeight:700,color:C.textSoft,marginBottom:6}}>æ­£è§£ã¯ <span style={{color:C.mintDark,fontWeight:800}} className="correct-val">{question.answer}</span></div>{!isTA&&<HintFor q={question} lv={level}/>}{!isTA&&<button onClick={goNext} className="next-btn" style={{marginTop:18,padding:"12px 40px",borderRadius:14,border:"none",background:`linear-gradient(135deg,${C.mint},${C.mintDark})`,color:"#fff",fontWeight:700,cursor:"pointer"}}>{questionNum+1>=totalQ?"ã‘ã£ã‹ã‚’è¦‹ã‚‹":"ã¤ãã¸ â†’"}</button>}</div>)}
        {!feedback&&!isTA&&(<><button onClick={()=>setShowHint(!showHint)} className="hint-toggle" style={{marginTop:4,background:"none",border:"none",color:C.textSoft,cursor:"pointer",textDecoration:"underline",textDecorationStyle:"dotted"}}>{showHint?"ã¨ã˜ã‚‹":"ğŸ“– è§£ãæ–¹ã‚’å­¦ã¶"}</button>{showHint&&<HintFor q={question} lv={level}/>}</>)}
      </div>
      <style>{GS}</style>
    </div>);}

  /* â”€â”€ RESULT â”€â”€ */
  if(screen==="result"){
    const bd=resultBd||{clearAlt:0,firstAlt:0,totalAltEarned:0,stars:0,isFirst:false};
    const perfect=!isTA&&correctCount===totalQ;const passed=bd.stars>=1;
    const avg=elapsed>0&&answered>0?(elapsed/answered).toFixed(1):"â€”";
    const rankTabStyle=(t)=>({flex:1,padding:"8px",borderRadius:10,border:"none",fontWeight:700,fontSize:13,cursor:"pointer",background:rankTab===t?C.mint:"transparent",color:rankTab===t?"#fff":C.textSoft});
    return(
    <div className="omiyage-root screen-result" style={{minHeight:"100vh",background:C.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:20,color:C.text}}>
      <WafuDeco/>
      {perfect&&<Confetti/>}
      <div className="result-card" style={{width:"100%",background:C.card,borderRadius:24,padding:"36px 24px",textAlign:"center",border:`2px solid ${C.cardBorder}`,boxShadow:"0 4px 20px rgba(0,0,0,0.05)",animation:"fadeInScale 0.5s ease"}}>
        <div className="result-emoji" style={{marginBottom:12,animation:"floatBounce 1.5s ease-in-out infinite"}}>{perfect?"ğŸ†":passed?"ğŸŠ":"ğŸ’ª"}</div>
        <h2 className="result-heading" style={{fontWeight:900,marginBottom:4,color:perfect?C.orange:passed?C.mintDark:C.pinkDark}}>{perfect?"ã‹ã‚“ãºãï¼ï¼":passed?"ã‚ˆããŒã‚“ã°ã£ãŸã­ï¼":"ã‚‚ã†å°‘ã—ï¼"}</h2>
        <p style={{color:C.textSoft,marginBottom:12}}>{level.name} â€” {level.label}</p>
        <div style={{display:"flex",justifyContent:"center",gap:6,marginBottom:16}}>{[1,2,3].map(s=><span key={s} className="result-star" style={{filter:s<=bd.stars?"none":"grayscale(1) opacity(0.25)",animation:s<=bd.stars?`popIn 0.3s ${0.15*s}s ease both`:undefined}}>â­</span>)}</div>

        {/* Game Stats */}
        <div className="result-stats" style={{display:"grid",gap:10,marginBottom:16,gridTemplateColumns:isTA?"1fr 1fr 1fr":"1fr 1fr 1fr 1fr"}}>
          <div style={{background:C.orangeLight,borderRadius:14,padding:"12px 8px",border:`1px solid ${C.orange}`}}><div className="stat-val" style={{fontWeight:900,color:C.orange}}>{score}</div><div className="stat-label" style={{color:C.textSoft,marginTop:2}}>ã‚¹ã‚³ã‚¢</div></div>
          <div style={{background:C.mintLight,borderRadius:14,padding:"12px 8px",border:`1px solid ${C.mint}`}}><div className="stat-val" style={{fontWeight:900,color:C.mintDark}}>{isTA?correctCount:`${correctCount}/${totalQ}`}</div><div className="stat-label" style={{color:C.textSoft,marginTop:2}}>æ­£è§£æ•°</div></div>
          {isTA?<div style={{background:C.cream,borderRadius:14,padding:"12px 8px",border:`1px solid ${C.creamDark}`}}><div className="stat-val" style={{fontWeight:900,color:C.orange}}>{answered}å•</div><div className="stat-label" style={{color:C.textSoft,marginTop:2}}>ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div></div>
          :<><div style={{background:C.pinkLight,borderRadius:14,padding:"12px 8px",border:`1px solid ${C.pink}`}}><div className="stat-val" style={{fontWeight:900,color:C.pinkDark}}>{fmt(elapsed)}</div><div className="stat-label" style={{color:C.textSoft,marginTop:2}}>ã‚¿ã‚¤ãƒ </div></div><div style={{background:C.cream,borderRadius:14,padding:"12px 8px",border:`1px solid ${C.creamDark}`}}><div className="stat-val" style={{fontWeight:900,color:C.orange}}>{avg}ç§’</div><div className="stat-label" style={{color:C.textSoft,marginTop:2}}>å¹³å‡</div></div></>}
        </div>

        {/* ALT Reward - big display */}
        {bd.totalAltEarned>0&&(
          <div style={{background:`linear-gradient(135deg,${C.cream},${C.orangeLight})`,borderRadius:20,padding:"20px",border:`3px solid ${C.creamDark}`,marginBottom:16,animation:"altDrop 0.6s 0.4s ease both"}}>
            <div style={{fontSize:14,color:C.textSoft,fontWeight:700,marginBottom:6}}>ğŸª™ ALTç²å¾—ï¼</div>
            <div style={{fontSize:42,fontWeight:900,color:C.orange,lineHeight:1,marginBottom:8}}>+{bd.totalAltEarned}<span style={{fontSize:18,marginLeft:4}}>ALT</span></div>
            <div style={{display:"flex",flexDirection:"column",gap:3,fontSize:12,color:C.textSoft}}>
              <div style={{display:"flex",justifyContent:"space-between"}}><span>{"â­".repeat(bd.stars)} ã‚¯ãƒªã‚¢å ±é…¬</span><span style={{fontWeight:700,color:C.text}}>+{bd.clearAlt}</span></div>
              {bd.isFirst&&<div style={{display:"flex",justifyContent:"space-between"}}><span>ğŸ†• åˆã‚¯ãƒªã‚¢</span><span style={{fontWeight:700,color:C.orange}}>+{bd.firstAlt}</span></div>}
            </div>
            <div style={{borderTop:`1px solid ${C.creamDark}`,marginTop:8,paddingTop:8,fontSize:14,fontWeight:800,color:C.orange,textAlign:"right"}}>åˆè¨ˆ ğŸª™ {altTotal} ALT</div>
          </div>
        )}

        {/* Ranking section (Time Attack only) */}
        {isTA&&(
          <div style={{background:C.bg,borderRadius:16,padding:"16px",border:`2px solid ${C.cardBorder}`,marginBottom:16,animation:"fadeInUp 0.4s 0.6s ease both"}}>
            <div style={{fontSize:15,fontWeight:800,color:C.text,marginBottom:10}}>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²</div>
            {!rankSubmitted?(
              <div style={{display:"flex",gap:8}}>
                <input value={rankName} onChange={e=>setRankName(e.target.value)} placeholder="ãªã¾ãˆ" disabled={rankSubmitting} style={{flex:1,padding:"10px 12px",borderRadius:10,border:`2px solid ${C.cardBorder}`,background:C.card,color:C.text,fontWeight:600,outline:"none",fontFamily:"inherit",fontSize:14}} onFocus={e=>e.target.style.borderColor=C.orange} onBlur={e=>e.target.style.borderColor=C.cardBorder}/>
                <button onClick={handleRankSubmit} disabled={!rankName.trim()||rankSubmitting} style={{padding:"10px 18px",borderRadius:10,border:"none",background:rankName.trim()&&!rankSubmitting?`linear-gradient(135deg,${C.orange},#e8941e)`:C.bgSoft,color:rankName.trim()&&!rankSubmitting?"#fff":C.textMuted,fontWeight:700,cursor:rankName.trim()&&!rankSubmitting?"pointer":"not-allowed",fontSize:14,minWidth:60}}>{rankSubmitting?"â³":"ç™»éŒ²"}</button>
              </div>
            ):(
              <div>
                {rankResult?.weekRank&&rankResult.weekRank<=10&&<div style={{background:C.cream,borderRadius:12,padding:"10px",marginBottom:8,border:`2px solid ${C.creamDark}`,animation:"popIn 0.3s ease"}}><span style={{fontSize:16,fontWeight:900,color:C.orange}}>ğŸ‰ ä»Šé€± {rankResult.weekRank}ä½ã«ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ï¼</span></div>}
                {rankResult?.allRank&&rankResult.allRank<=10&&<div style={{background:C.mintLight,borderRadius:12,padding:"10px",marginBottom:8,border:`2px solid ${C.mint}`,animation:"popIn 0.3s 0.1s ease both"}}><span style={{fontSize:16,fontWeight:900,color:C.mintDark}}>ğŸ‘‘ æ°¸ä¹… {rankResult.allRank}ä½ã«ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ï¼</span></div>}
                <div style={{display:"flex",gap:4,marginBottom:8,background:C.bgSoft,borderRadius:12,padding:3}}>
                  <button onClick={()=>setRankTab("week")} style={rankTabStyle("week")}>ğŸ“… ä»Šé€±</button>
                  <button onClick={()=>setRankTab("all")} style={rankTabStyle("all")}>ğŸ‘‘ æ°¸ä¹…</button>
                </div>
                <RankingTable data={rankTab==="week"?rankResult?.data?.week:rankResult?.data?.all} myName={rankName.trim()}/>
              </div>
            )}
          </div>
        )}

        {perfect&&<div style={{marginBottom:16,padding:"14px 18px",borderRadius:16,background:`linear-gradient(135deg,${C.cream},${C.orangeLight})`,border:`2px solid ${C.creamDark}`}}><div style={{fontWeight:800,color:C.orange,marginBottom:2}}>ğŸ“ ãƒã‚¹ã‚¿ãƒ¼èªå®šï¼</div><div style={{color:C.textSoft,fontSize:12}}>å…¨å•æ­£è§£ãŠã‚ã§ã¨ã†ï¼</div></div>}

        <div style={{display:"flex",gap:10,justifyContent:"center",flexWrap:"wrap"}}>
          <button onClick={()=>startLevel(currentLevel)} className="action-btn" style={{padding:"12px 28px",borderRadius:14,border:`2px solid ${C.mint}`,background:"transparent",color:C.mintDark,fontWeight:700,cursor:"pointer"}}>ã‚‚ã†ä¸€å›</button>
          {passed&&currentLevel<LEVELS.length-1&&<button onClick={()=>startLevel(currentLevel+1)} className="action-btn" style={{padding:"12px 28px",borderRadius:14,border:"none",background:`linear-gradient(135deg,${C.mint},${C.mintDark})`,color:"#fff",fontWeight:700,cursor:"pointer"}}>æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸ â†’</button>}
          <button onClick={()=>setScreen("title")} className="action-btn" style={{padding:"12px 28px",borderRadius:14,border:`2px solid ${C.cardBorder}`,background:"transparent",color:C.textSoft,fontWeight:600,cursor:"pointer"}}>ãƒ¬ãƒ™ãƒ«é¸æŠ</button>
        </div>
      </div>
      <style>{GS}</style>
    </div>);}
  return null;
}

const GS=`
.omiyage-root{font-family:'Noto Sans JP','Hiragino Sans',sans-serif;position:relative;overflow:hidden;}
.omiyage-root::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;}
.omiyage-root>*{position:relative;z-index:2;}

/* â”€â”€ å’Œç´™ãƒ†ã‚¯ã‚¹ãƒãƒ£ â”€â”€ */
.washi{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  background-size:256px 256px;}

/* â”€â”€ å’ŒæŸ„ãƒ‘ã‚¿ãƒ¼ãƒ³ â”€â”€ */
/* éº»ã®è‘‰ - ãƒ›ãƒ¼ãƒ ï¼ˆè–„ã„ãƒŸãƒ³ãƒˆã‚°ãƒªãƒ¼ãƒ³ï¼‰ */
.screen-title::before{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='52'%3E%3Cpath d='M30 0L60 26L30 52L0 26Z' fill='%23d4f0e0' stroke='%234aa578' stroke-width='0.8'/%3E%3Cpath d='M30 0L30 52M0 26L60 26M30 0L0 26M30 0L60 26M30 52L0 26M30 52L60 26' fill='none' stroke='%234aa578' stroke-width='0.4'/%3E%3C/svg%3E");
  background-size:60px 52px;opacity:0.12;
}
/* é’æµ·æ³¢ - ã‚²ãƒ¼ãƒ  */
.screen-game::before{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='40'%3E%3Ccircle cx='40' cy='40' r='32' fill='none' stroke='%237ecba1' stroke-width='0.7'/%3E%3Ccircle cx='40' cy='40' r='24' fill='none' stroke='%237ecba1' stroke-width='0.7'/%3E%3Ccircle cx='40' cy='40' r='16' fill='none' stroke='%237ecba1' stroke-width='0.7'/%3E%3Ccircle cx='0' cy='40' r='32' fill='none' stroke='%237ecba1' stroke-width='0.7'/%3E%3Ccircle cx='0' cy='40' r='24' fill='none' stroke='%237ecba1' stroke-width='0.7'/%3E%3Ccircle cx='0' cy='40' r='16' fill='none' stroke='%237ecba1' stroke-width='0.7'/%3E%3Ccircle cx='80' cy='40' r='32' fill='none' stroke='%237ecba1' stroke-width='0.7'/%3E%3Ccircle cx='80' cy='40' r='24' fill='none' stroke='%237ecba1' stroke-width='0.7'/%3E%3Ccircle cx='80' cy='40' r='16' fill='none' stroke='%237ecba1' stroke-width='0.7'/%3E%3C/svg%3E");
  background-size:80px 40px;opacity:0.10;
}
/* å¸‚æ¾ - ãƒªã‚¶ãƒ«ãƒˆ */
.screen-result::before{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Crect width='20' height='20' fill='%23f5a623'/%3E%3Crect x='20' y='20' width='20' height='20' fill='%23f5a623'/%3E%3C/svg%3E");
  background-size:40px 40px;opacity:0.07;
}
/* ä¸ƒå® - ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
.screen-ranking::before{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48'%3E%3Ccircle cx='24' cy='0' r='20' fill='none' stroke='%23f5a623' stroke-width='0.8'/%3E%3Ccircle cx='24' cy='48' r='20' fill='none' stroke='%23f5a623' stroke-width='0.8'/%3E%3Ccircle cx='0' cy='24' r='20' fill='none' stroke='%23f5a623' stroke-width='0.8'/%3E%3Ccircle cx='48' cy='24' r='20' fill='none' stroke='%23f5a623' stroke-width='0.8'/%3E%3C/svg%3E");
  background-size:48px 48px;opacity:0.10;
}

/* â”€â”€ é›² â”€â”€ */
.kumo{position:fixed;pointer-events:none;z-index:1;}
.kumo-1{width:180px;top:3%;right:-20px;color:rgba(126,203,161,0.10);animation:kumoFloat1 20s ease-in-out infinite;}
.kumo-2{width:130px;bottom:8%;left:-15px;color:rgba(242,161,179,0.10);animation:kumoFloat2 25s ease-in-out infinite;}
.screen-title .kumo-1{color:rgba(74,165,120,0.12);}.screen-title .kumo-2{color:rgba(229,57,53,0.08);}
.screen-game .kumo-1{color:rgba(126,203,161,0.10);}.screen-game .kumo-2{color:rgba(126,203,161,0.08);}
.screen-result .kumo-1{color:rgba(245,166,35,0.10);}.screen-result .kumo-2{color:rgba(245,166,35,0.08);}
.screen-ranking .kumo-1{color:rgba(245,166,35,0.12);}.screen-ranking .kumo-2{color:rgba(212,69,107,0.08);}

/* â”€â”€ æ¡œ â”€â”€ */
.sakura{position:fixed;pointer-events:none;z-index:1;}
.sakura-1{width:38px;top:5%;left:6%;color:rgba(242,161,179,0.32);animation:sakuraR 28s linear infinite,sakuraP 4s ease-in-out infinite;}
.sakura-2{width:26px;top:3%;right:12%;color:rgba(242,161,179,0.25);animation:sakuraR 36s linear infinite reverse,sakuraP 5s ease-in-out 0.5s infinite;}
.sakura-3{width:20px;top:18%;right:5%;color:rgba(242,161,179,0.28);animation:sakuraR 32s linear infinite,sakuraP 4.5s ease-in-out 1s infinite;}
.sakura-4{width:32px;bottom:12%;left:4%;color:rgba(242,161,179,0.26);animation:sakuraR 40s linear infinite reverse,sakuraP 5.5s ease-in-out 1.5s infinite;}
.sakura-5{width:16px;bottom:25%;right:8%;color:rgba(242,161,179,0.22);animation:sakuraR 34s linear infinite,sakuraP 3.5s ease-in-out 2s infinite;}
.sakura-6{width:22px;top:40%;left:3%;color:rgba(242,161,179,0.20);animation:sakuraR 38s linear infinite reverse,sakuraP 4.8s ease-in-out 0.8s infinite;}
.sakura-7{width:18px;bottom:5%;right:18%;color:rgba(242,161,179,0.24);animation:sakuraR 30s linear infinite,sakuraP 4.2s ease-in-out 1.2s infinite;}
.screen-result .sakura{color:rgba(245,166,35,0.22);}
.screen-ranking .sakura-1,.screen-ranking .sakura-4{color:rgba(245,166,35,0.24);}

@keyframes kumoFloat1{0%,100%{transform:translateX(0) translateY(0)}50%{transform:translateX(-15px) translateY(8px)}}
@keyframes kumoFloat2{0%,100%{transform:translateX(0) translateY(0)}50%{transform:translateX(12px) translateY(-6px)}}
@keyframes sakuraR{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes sakuraP{0%,100%{opacity:1}50%{opacity:0.5}}
.title-emoji{font-size:54px;}.title-heading{font-size:36px;line-height:1.3;}.title-sub{font-size:15px;}
.level-grid-sakuranbo{grid-template-columns:1fr 1fr 1fr;max-width:400px;}
.level-grid-omiyage{grid-template-columns:1fr 1fr;max-width:400px;}
.level-ta{grid-column:1/-1;}.level-name{font-size:14px;}.level-label{font-size:11px;}
.ranking-card{max-width:400px;}
.game-header,.game-info,.question-card{max-width:420px;}
.question-num{font-size:48px;}.choice-btn{font-size:22px;}.hint-box{max-width:380px;}
.hint-title{font-size:14px;}.hint-num{font-size:18px;}.hint-op{font-size:19px;}.hint-big-num{font-size:32px;}.hint-answer{font-size:28px;}
.result-card{max-width:420px;}.result-emoji{font-size:48px;}.result-heading{font-size:26px;}.result-star{font-size:30px;}
.stat-val{font-size:22px;}.stat-label{font-size:11px;}.score-float-text{font-size:36px;}.alt-float-text{font-size:36px;}
.combo-char{font-size:14px;}.combo-emoji{font-size:26px;}.score-display{font-size:15px;}
.back-btn{font-size:14px;}.elapsed{font-size:13px;}.game-meta{font-size:13px;}.timer-text{font-size:13px;}.time-bonus{font-size:18px;}
.action-btn{font-size:15px;}.praise{font-size:20px;}.wrong-answer{font-size:16px;}.correct-val{font-size:20px;}
@media(min-width:600px){
  .title-emoji{font-size:72px;}.title-heading{font-size:48px;}.title-sub{font-size:18px;}
  .level-grid-sakuranbo{max-width:560px;}.level-grid-omiyage{grid-template-columns:1fr 1fr 1fr 1fr;max-width:680px;}
  .level-name{font-size:17px;}.level-label{font-size:13px;}
  .ranking-card{max-width:560px;}
  .game-header,.game-info,.question-card{max-width:600px;}
  .question-num{font-size:64px;}.choice-btn{font-size:28px;padding:24px 12px!important;}
  .hint-box{max-width:520px;}.hint-big-num{font-size:40px;}.hint-answer{font-size:34px;}
  .result-card{max-width:600px;padding:48px 36px;}.result-emoji{font-size:64px;}.result-heading{font-size:32px;}.result-star{font-size:40px;}
  .stat-val{font-size:28px;}.score-float-text{font-size:48px;}.combo-char{font-size:18px;}.combo-emoji{font-size:36px;}
  .action-btn{font-size:17px;padding:14px 36px;}
}
@media(min-width:900px){
  .level-grid-omiyage{max-width:800px;}.level-grid-sakuranbo{max-width:680px;}
  .game-header,.game-info,.question-card{max-width:700px;}.question-num{font-size:72px;}.choice-btn{font-size:32px;padding:28px 16px!important;}
  .result-card{max-width:700px;}.ranking-card{max-width:640px;}.hint-box{max-width:600px;}
}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}}
@keyframes popIn{0%{transform:scale(0.7);opacity:0}100%{transform:scale(1);opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
@keyframes fadeInUp{0%{opacity:0;transform:translateY(16px)}100%{opacity:1;transform:translateY(0)}}
@keyframes fadeInScale{0%{opacity:0;transform:scale(0.92)}100%{opacity:1;transform:scale(1)}}
@keyframes slideIn{0%{opacity:0;transform:translateX(40px)}100%{opacity:1;transform:translateX(0)}}
@keyframes slideUp{0%{opacity:0;transform:translateY(12px)}100%{opacity:1;transform:translateY(0)}}
@keyframes choiceAppear{0%{opacity:0;transform:translateY(14px) scale(0.94)}100%{opacity:1;transform:translateY(0) scale(1)}}
@keyframes floatBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes comboBounce{0%{transform:translateY(0) scale(1)}40%{transform:translateY(-12px) scale(1.15)}100%{transform:translateY(0) scale(1)}}
@keyframes comboSpin{0%{transform:rotate(0) scale(1)}50%{transform:rotate(180deg) scale(1.3)}100%{transform:rotate(360deg) scale(1)}}
@keyframes confettiFall{0%{transform:translateY(0) translateX(0) rotate(0);opacity:1}100%{transform:translateY(100vh) translateX(var(--drift)) rotate(720deg);opacity:0}}
@keyframes timeBonusPop{0%{opacity:1;transform:translateY(0) scale(1)}50%{opacity:1;transform:translateY(-18px) scale(1.2)}100%{opacity:0;transform:translateY(-36px) scale(0.8)}}
@keyframes scoreFloat{0%{opacity:1;transform:translate(-50%,-50%) scale(0.8)}30%{opacity:1;transform:translate(-50%,-70%) scale(1.15)}100%{opacity:0;transform:translate(-50%,-110%) scale(0.7)}}
@keyframes altDrop{0%{opacity:0;transform:scale(0.5) translateY(-30px)}60%{opacity:1;transform:scale(1.05) translateY(0)}100%{opacity:1;transform:scale(1) translateY(0)}}
`;

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(OmiyageGame));
</script>
</body>
</html>
